<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bluetooth Scanner v1.61</title>
</head>
<body>
  <h1>Bluetooth Device Scanner v1.61</h1>
  <button id="scanButton">Scan for Bluetooth Devices</button>
  <div id="deviceInfo"></div>

  <script>
    // Check if the Web Bluetooth API is available
    if (!navigator.bluetooth) {
      console.error('Web Bluetooth is not available in this browser. Please use Chrome, Edge, or another supported browser.');
      document.getElementById('deviceInfo').innerText = 'Web Bluetooth is not available in this browser. Please use Chrome, Edge, or another supported browser.';
    } else {
      console.log('Web Bluetooth is supported!');
    }

    // Function to start scanning for Bluetooth devices
    async function scanForBluetoothDevices() {
      try {
        // Request Bluetooth devices with certain options
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['d30a7847-e12b-09a8-b04b-8e0922a9abab','d10a7847-e12b-09a8-b04b-8e0922a9abab']
        });

        console.log(`Found device: ${device.name}`);
        document.getElementById('deviceInfo').innerHTML = `<h2>Found device: ${device.name}</h2>`;

        // Connect to the device and fetch services
        const server = await device.gatt.connect();

        // Display device properties after connection
        const deviceInfo = document.createElement('div');
        deviceInfo.innerHTML = `
          <p>Device ID: ${device.id}</p>
          <p>Device Name: ${device.name}</p>
          <p>Device GATT Connected: ${device.gatt.connected}</p>
        `;
        document.getElementById('deviceInfo').appendChild(deviceInfo);

        const services = await server.getPrimaryServices();

        // Iterate over all available services and list characteristics
        for (const service of services) {
          const serviceInfo = document.createElement('div');
          serviceInfo.innerHTML = `<h3>Service: ${service.uuid}</h3>`;
          document.getElementById('deviceInfo').appendChild(serviceInfo);

          const characteristics = await service.getCharacteristics();
          for (const characteristic of characteristics) {
            const characteristicInfo = document.createElement('div');
            characteristicInfo.style.marginLeft = '20px';
            characteristicInfo.innerHTML = `Characteristic: ${characteristic.uuid} - Properties: ${Object.keys(characteristic.properties).filter(prop => characteristic.properties[prop]).join(', ')}`;
            serviceInfo.appendChild(characteristicInfo);

            try {
              // Read characteristic value
              const value = await characteristic.readValue();
              let valueText = '';
              for (let i = 0; i < value.byteLength; i++) {
                valueText += String.fromCharCode(value.getUint8(i));
              }
              const valueElement = document.createElement('div');
              valueElement.style.marginLeft = '40px';
              valueElement.innerHTML = `Value: ${valueText}`;
              characteristicInfo.appendChild(valueElement);
            } catch (error) {
              console.warn(`Unable to read value for characteristic ${characteristic.uuid}:`, error);
            }

            // Subscribe to notifications if available
            if (characteristic.properties.notify) {
              try {
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                  const value = event.target.value;
                  let valueText = '';
                  for (let i = 0; i < value.byteLength; i++) {
                    valueText += String.fromCharCode(value.getUint8(i));
                  }
                  const notificationElement = document.createElement('div');
                  notificationElement.style.marginLeft = '40px';
                  notificationElement.innerHTML = `Notification Value: ${valueText}`;
                  characteristicInfo.appendChild(notificationElement);
                });
              } catch (error) {
                console.warn(`Unable to subscribe to notifications for characteristic ${characteristic.uuid}:`, error);
              }
            }

            // Discover descriptors for each characteristic
            try {
              const descriptors = await characteristic.getDescriptors();
              for (const descriptor of descriptors) {
                const descriptorInfo = document.createElement('div');
                descriptorInfo.style.marginLeft = '40px';
                descriptorInfo.innerHTML = `Descriptor: ${descriptor.uuid}`;
                characteristicInfo.appendChild(descriptorInfo);

                try {
                  const value = await descriptor.readValue();
                  let valueText = '';
                  for (let i = 0; i < value.byteLength; i++) {
                    valueText += String.fromCharCode(value.getUint8(i));
                  }
                  const descriptorValueElement = document.createElement('div');
                  descriptorValueElement.style.marginLeft = '60px';
                  descriptorValueElement.innerHTML = `Descriptor Value: ${valueText}`;
                  descriptorInfo.appendChild(descriptorValueElement);
                } catch (error) {
                  console.warn(`Unable to read value for descriptor ${descriptor.uuid}:`, error);
                }
              }
            } catch (error) {
              console.warn(`Unable to get descriptors for characteristic ${characteristic.uuid}:`, error);
            }
          }
        }
      } catch (error) {
        console.error('Error during Bluetooth scan:', error);
        document.getElementById('deviceInfo').innerText = `Error during Bluetooth scan: ${error.message}`;
      }
    }

    // Attach the scan function to a button for user interaction
    document.getElementById('scanButton').addEventListener('click', scanForBluetoothDevices);
  </script>
</body>
</html>
