<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bluetooth Device Status Checker - Version 3.42</title>
    <style>
        /* Basic styling for the application */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }

        h1 {
            color: #333;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007BFF;
            color: #fff;
            border: none;
            border-radius: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .status {
            margin-top: 30px;
            font-size: 24px;
        }

        .green {
            color: green;
        }

        .red {
            color: red;
        }

        p {
            margin: 10px 0;
        }

        .error {
            color: red;
        }

        .input-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 18px;
        }

        input[type="text"], input[type="password"] {
            padding: 10px;
            font-size: 16px;
            width: 80%;
            max-width: 300px;
            margin-bottom: 10px;
        }

        #connectBtn {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
        }

        #connectBtn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <h1>Bluetooth Device Status Checker - Version 3.42</h1>
    <button id="checkStatusBtn">Check machine status</button>
    <div id="status" class="status"></div>

    <script>
        const supportedPrefixes = ['lcr', 'micra', 'linea', 'gs3', 'kb90', 'gb5', 'strada', 'bluez'];
        let connectedDevice = null;
        let globalServer = null;
        let selectedService = null;
        let stepVariant = '';
        let ssidCharacteristicUUID = '';
        let passwordCharacteristicUUID = '';
        let triggerCharacteristicUUID = '';

        document.getElementById('checkStatusBtn').addEventListener('click', function() {
            const optionalServices = [
                '0000180a-0000-1000-8000-00805f9b34fb', // Device Information service
                // Variant 1 Services
                'd30a7847-e12b-09a8-b04b-8e0922a9abab',
                'd10a7847-e12b-09a8-b04b-8e0922a9abab',
                // Variant 2 Services
                'a0345678-1234-5678-1234-56789abcdef1',
                'a0345678-1234-5678-1234-56789abcdef0',
                // Variant 1 Characteristics
                '030b7847-e12b-09a8-b04b-8e0922a9abab',
                '040b7847-e12b-09a8-b04b-8e0922a9abab',
                'd70a7847-e12b-09a8-b04b-8e0922a9abab',
                'd80a7847-e12b-09a8-b04b-8e0922a9abab',
                'dc0a7847-e12b-09a8-b04b-8e0922a9abab',
                // Variant 2 Characteristics
                'ababa922-098e-4bb0-a809-2be147780b03',
                'ababa922-098e-4bb0-a809-2be147780b04',
                'ababa922-098e-4bb0-a809-2be147780ad7',
                'ababa922-098e-4bb0-a809-2be147780ad8',
                'ababa922-098e-4bb0-a809-2be147780adc'
            ];

            navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: optionalServices
            })
            .then(device => {
                connectedDevice = device; // Store the device globally for disconnection later
                const deviceName = device.name || device.deviceName || 'Unknown Device';
                const deviceNameLower = deviceName.toLowerCase();

                if (!supportedPrefixes.some(prefix => deviceNameLower.startsWith(prefix))) {
                    displayStatus('<p>Unsupported device</p>');
                    disconnectDevice(); // Disconnect if unsupported
                    return;
                }

                displayStatus('<p>Connecting to ' + deviceName + '...</p>');

                return device.gatt.connect().then(server => ({ server: server, deviceName: deviceName }));
            })
            .then(obj => {
                if (!obj) return;

                globalServer = obj.server; // Store server globally
                const deviceName = obj.deviceName;

                // Get Device Information Service
                return globalServer.getPrimaryService('0000180a-0000-1000-8000-00805f9b34fb')
                .then(deviceInfoService => {
                    return deviceInfoService.getCharacteristics()
                    .then(characteristics => {
                        let promises = [];
                        let machineFirmware = '';
                        let gatewayFirmware = '';

                        characteristics.forEach(characteristic => {
                            const uuid = characteristic.uuid.toLowerCase();
                            if (uuid.includes('2a26')) {
                                promises.push(
                                    characteristic.readValue().then(value => {
                                        const decoder = new TextDecoder('utf-8');
                                        machineFirmware = decoder.decode(value);
                                    })
                                );
                            } else if (uuid.includes('2a28')) {
                                promises.push(
                                    characteristic.readValue().then(value => {
                                        const decoder = new TextDecoder('utf-8');
                                        gatewayFirmware = decoder.decode(value);
                                    })
                                );
                            }
                        });

                        return Promise.all(promises).then(() => ({ server: globalServer, deviceName: deviceName, machineFirmware: machineFirmware, gatewayFirmware: gatewayFirmware }));
                    });
                })
                .then(obj => {
                    const server = obj.server;
                    const deviceName = obj.deviceName;
                    const machineFirmware = obj.machineFirmware;
                    const gatewayFirmware = obj.gatewayFirmware;

                    const serviceUUIDs = [
                        'd30a7847-e12b-09a8-b04b-8e0922a9abab',
                        'd10a7847-e12b-09a8-b04b-8e0922a9abab',
                        'a0345678-1234-5678-1234-56789abcdef1',
                        'a0345678-1234-5678-1234-56789abcdef0',
                        'ababa922-098e-4bb0-a809-2be147780b01',
                        'ababa922-098e-4bb0-a809-2be147780b02'
                    ];

                    const serviceMap = {
                        'd30a7847-e12b-09a8-b04b-8e0922a9abab': 'StepVariant1Closed',
                        'd10a7847-e12b-09a8-b04b-8e0922a9abab': 'StepVariant1Open',
                        'a0345678-1234-5678-1234-56789abcdef1': 'StepVariant2Closed',
                        'a0345678-1234-5678-1234-56789abcdef0': 'StepVariant2Open',
                    };

                    return Promise.all(serviceUUIDs.map(uuid => {
                        return server.getPrimaryService(uuid.toLowerCase())
                            .then(service => ({ uuid: uuid.toLowerCase(), service: service }))
                            .catch(() => null);
                    }))
                    .then(services => {
                        services = services.filter(serviceObj => serviceObj !== null);

                        if (services.length === 0) {
                            displayStatus('<p>Unknown error</p>');
                            disconnectDevice();
                            return;
                        }

                        const matchedServiceObj = services[0];
                        selectedService = matchedServiceObj.service;
                        stepVariant = serviceMap[matchedServiceObj.uuid];

                        if (stepVariant.startsWith('StepVariant1')) {
                            handleStepVariant1(selectedService, deviceName, machineFirmware, gatewayFirmware, stepVariant);
                        } else if (stepVariant.startsWith('StepVariant2')) {
                            handleStepVariant2(selectedService, deviceName, machineFirmware, gatewayFirmware, stepVariant);
                        } else {
                            displayStatus('<p>Unknown error</p>');
                            disconnectDevice();
                        }
                    });
                });
            })
            .catch(error => {
                console.log(error);
                displayStatus('<p class="error">Error, please retry.</p>');
                disconnectDevice();
            });
        });

        function readCharacteristicValue(characteristic) {
            return characteristic.readValue()
                .then(value => {
                    let val;
                    if (value.byteLength === 1) {
                        // Read as unsigned 8-bit integer
                        val = value.getUint8(0);
                    } else {
                        const decoder = new TextDecoder('utf-8');
                        val = decoder.decode(value).trim();
                    }
                    return val;
                });
        }

        function handleStepVariant1(service, deviceName, machineFirmware, gatewayFirmware, stepVariant) {
            let characteristicUUIDs = [];
            let isOpen = false;

            if (stepVariant === 'StepVariant1Open') {
                isOpen = true;
                characteristicUUIDs = [
                    '030b7847-e12b-09a8-b04b-8e0922a9abab',
                    '040b7847-e12b-09a8-b04b-8e0922a9abab',
                    'd70a7847-e12b-09a8-b04b-8e0922a9abab' // SSID
                ];
                ssidCharacteristicUUID = 'd70a7847-e12b-09a8-b04b-8e0922a9abab';
                passwordCharacteristicUUID = 'd80a7847-e12b-09a8-b04b-8e0922a9abab';
                triggerCharacteristicUUID = 'dc0a7847-e12b-09a8-b04b-8e0922a9abab';
            } else {
                characteristicUUIDs = [
                    '030b7847-e12b-09a8-b04b-8e0922a9abab',
                    '040b7847-e12b-09a8-b04b-8e0922a9abab'
                ];
            }

            service.getCharacteristics()
            .then(characteristics => {
                const availableUUIDs = characteristics.map(c => c.uuid.toLowerCase());
                characteristicUUIDs = characteristicUUIDs.filter(uuid => availableUUIDs.includes(uuid));

                return Promise.all(characteristicUUIDs.map(uuid => {
                    return service.getCharacteristic(uuid)
                        .then(characteristic => readCharacteristicValue(characteristic))
                        .then(val => {
                            return { uuid: uuid, value: val };
                        });
                }));
            })
            .then(results => {
                let statusHtml = `<h2>${deviceName}</h2>`;

                if (machineFirmware) {
                    statusHtml += `<p>Machine Firmware: ${machineFirmware}</p>`;
                }
                if (gatewayFirmware) {
                    statusHtml += `<p>Gateway Firmware: ${gatewayFirmware}</p>`;
                }

                results.forEach(result => {
                    const uuid = result.uuid.toLowerCase();
                    let val = result.value;
                    if (uuid === '030b7847-e12b-09a8-b04b-8e0922a9abab' || uuid === '040b7847-e12b-09a8-b04b-8e0922a9abab') {
                        if (typeof val === 'number') {
                            val = val ? '1' : '0';
                        } else {
                            val = val.toLowerCase();
                        }
                        if (uuid === '030b7847-e12b-09a8-b04b-8e0922a9abab') {
                            statusHtml += (val === 'true' || val === '1')
                                ? '<p class="green">Connected to router</p>'
                                : '<p class="red">Not connected to router</p>';
                        } else if (uuid === '040b7847-e12b-09a8-b04b-8e0922a9abab') {
                            statusHtml += (val === 'true' || val === '1')
                                ? '<p class="green">Connected to cloud</p>'
                                : '<p class="red">Not connected to cloud</p>';
                        }
                    }
                });

                if (isOpen) {
                    const ssidResult = results.find(result => result.uuid.toLowerCase() === ssidCharacteristicUUID.toLowerCase());
                    const ssidValue = ssidResult ? ssidResult.value : '';
                    statusHtml += `
                        <div class="input-group">
                            <label for="ssidInput">WiFi Network Name</label>
                            <input type="text" id="ssidInput" value="${ssidValue}">
                        </div>
                        <div class="input-group">
                            <label for="passwordInput">WiFi Password</label>
                            <input type="password" id="passwordInput" placeholder="Enter WiFi Password">
                        </div>
                        <button id="connectBtn">Connect</button>
                    `;
                    displayStatus(statusHtml);

                    document.getElementById('connectBtn').addEventListener('click', function() {
                        writeWifiCredentials(service);
                    });
                } else {
                    statusHtml += '<p>Unlock gateway to configure WiFi network.</p>';
                    displayStatus(statusHtml);
                    disconnectDevice();
                }
            })
            .catch(error => {
                console.log(error);
                displayStatus('<p class="error">Error, please retry.</p>');
                disconnectDevice();
            });
        }

        function handleStepVariant2(service, deviceName, machineFirmware, gatewayFirmware, stepVariant) {
            let characteristicUUIDs = [];
            let isOpen = false;

            if (stepVariant === 'StepVariant2Open') {
                isOpen = true;
                characteristicUUIDs = [
                    'ababa922-098e-4bb0-a809-2be147780b03',
                    'ababa922-098e-4bb0-a809-2be147780b04',
                    'ababa922-098e-4bb0-a809-2be147780ad7' // SSID
                ];
                ssidCharacteristicUUID = 'ababa922-098e-4bb0-a809-2be147780ad7';
                passwordCharacteristicUUID = 'ababa922-098e-4bb0-a809-2be147780ad8';
                triggerCharacteristicUUID = 'ababa922-098e-4bb0-a809-2be147780adc';
            } else {
                characteristicUUIDs = [
                    'ababa922-098e-4bb0-a809-2be147780b03',
                    'ababa922-098e-4bb0-a809-2be147780b04'
                ];
            }

            service.getCharacteristics()
            .then(characteristics => {
                const availableUUIDs = characteristics.map(c => c.uuid.toLowerCase());
                characteristicUUIDs = characteristicUUIDs.filter(uuid => availableUUIDs.includes(uuid));

                return Promise.all(characteristicUUIDs.map(uuid => {
                    return service.getCharacteristic(uuid)
                        .then(characteristic => readCharacteristicValue(characteristic))
                        .then(val => {
                            return { uuid: uuid, value: val };
                        });
                }));
            })
            .then(results => {
                let statusHtml = `<h2>${deviceName}</h2>`;

                if (machineFirmware) {
                    statusHtml += `<p>Machine Firmware: ${machineFirmware}</p>`;
                }
                if (gatewayFirmware) {
                    statusHtml += `<p>Gateway Firmware: ${gatewayFirmware}</p>`;
                }

                results.forEach(result => {
                    const uuid = result.uuid.toLowerCase();
                    let val = result.value;
                    if (uuid === 'ababa922-098e-4bb0-a809-2be147780b03' || uuid === 'ababa922-098e-4bb0-a809-2be147780b04') {
                        let displayMessage = '';
                        if (typeof val === 'number') {
                            val = val.toString();
                        } else if (typeof val === 'boolean') {
                            val = val ? 'true' : 'false';
                        } else if (typeof val === 'string') {
                            val = val.toLowerCase();
                        }

                        if (val === 'true' || val === '1') {
                            displayMessage = (uuid === 'ababa922-098e-4bb0-a809-2be147780b03') ? '<p class="green">Connected to router</p>' : '<p class="green">Connected to cloud</p>';
                        } else if (val === 'false' || val === '0') {
                            displayMessage = (uuid === 'ababa922-098e-4bb0-a809-2be147780b03') ? '<p class="red">Not connected to router</p>' : '<p class="red">Not connected to cloud</p>';
                        } else {
                            // Display raw value
                            displayMessage = `<p>Characteristic ${uuid} value: ${val}</p>`;
                        }

                        statusHtml += displayMessage;
                    }
                });

                if (isOpen) {
                    const ssidResult = results.find(result => result.uuid.toLowerCase() === ssidCharacteristicUUID.toLowerCase());
                    const ssidValue = ssidResult ? ssidResult.value : '';
                    statusHtml += `
                        <div class="input-group">
                            <label for="ssidInput">WiFi Network Name</label>
                            <input type="text" id="ssidInput" value="${ssidValue}">
                        </div>
                        <div class="input-group">
                            <label for="passwordInput">WiFi Password</label>
                            <input type="password" id="passwordInput" placeholder="Enter WiFi Password">
                        </div>
                        <button id="connectBtn">Connect</button>
                    `;
                    displayStatus(statusHtml);

                    document.getElementById('connectBtn').addEventListener('click', function() {
                        writeWifiCredentials(service);
                    });
                } else {
                    statusHtml += '<p>Unlock gateway to configure WiFi network.</p>';
                    displayStatus(statusHtml);
                    disconnectDevice();
                }
            })
            .catch(error => {
                console.log(error);
                displayStatus('<p class="error">Error, please retry.</p>');
                disconnectDevice();
            });
        }

        function writeWifiCredentials(service) {
            const ssid = document.getElementById('ssidInput').value;
            const password = document.getElementById('passwordInput').value;

            Promise.all([
                service.getCharacteristic(ssidCharacteristicUUID.toLowerCase())
                    .then(characteristic => {
                        const encoder = new TextEncoder('utf-8');
                        const value = encoder.encode(ssid);
                        return characteristic.writeValue(value);
                    }),
                service.getCharacteristic(passwordCharacteristicUUID.toLowerCase())
                    .then(characteristic => {
                        const encoder = new TextEncoder('utf-8');
                        const value = encoder.encode(password);
                        return characteristic.writeValue(value);
                    })
            ])
            .then(() => {
                // Write 0x01 to trigger characteristic
                return service.getCharacteristic(triggerCharacteristicUUID.toLowerCase())
                    .then(characteristic => {
                        const value = new Uint8Array([0x01]);
                        return characteristic.writeValue(value);
                    });
            })
            .then(() => {
                displayStatus('<p>WiFi network updated</p>');
                disconnectDevice();
            })
            .catch(error => {
                console.log(error);
                displayStatus('<p class="error">Error, please retry.</p>');
                disconnectDevice();
            });
        }

        function disconnectDevice() {
            if (connectedDevice && connectedDevice.gatt.connected) {
                connectedDevice.gatt.disconnect();
                console.log('Device disconnected');
                connectedDevice = null;
                globalServer = null;
                selectedService = null;
                stepVariant = '';
                ssidCharacteristicUUID = '';
                passwordCharacteristicUUID = '';
                triggerCharacteristicUUID = '';
            }
        }

        function displayStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
        }
    </script>
</body>
</html>
