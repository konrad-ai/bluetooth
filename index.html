<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bluetooth Device Status Checker v2</title>
    <style>
        /* Basic styling for the application */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }

        h1 {
            color: #333;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007BFF;
            color: #fff;
            border: none;
            border-radius: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .status {
            margin-top: 30px;
            font-size: 24px;
        }

        .green {
            color: green;
        }

        .red {
            color: red;
        }

        p {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Bluetooth Device Status Checker</h1>
    <button id="checkStatusBtn">Check machine status</button>
    <div id="status" class="status"></div>

    <script>
        const supportedPrefixes = ['lcr', 'micra', 'linea', 'gs3', 'kb90', 'gb5', 'strada', 'bluez'];

        document.getElementById('checkStatusBtn').addEventListener('click', function() {
            const optionalServices = [
                'd30a7847-e12b-09a8-b04b-8e0922a9abab',
                'd10a7847-e12b-09a8-b04b-8e0922a9abab',
                'a0345678-1234-5678-1234-56789abcdef1',
                'a0345678-1234-5678-1234-56789abcdef0',
                '030b7847-e12b-09a8-b04b-8e0922a9abab',
                '040b7847-e12b-09a8-b04b-8e0922a9abab',
                'ababa922-098e-4bb0-a809-2be147780b03',
                'ababa922-098e-4bb0-a809-2be147780b04'
            ];

            navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: optionalServices
            })
            .then(device => {
                const deviceName = device.name || device.deviceName || 'Unknown Device';
                const deviceNameLower = deviceName.toLowerCase();

                if (!supportedPrefixes.some(prefix => deviceNameLower.startsWith(prefix))) {
                    displayStatus('Unsupported device');
                    return;
                }

                displayStatus('Connecting to ' + deviceName + '...');

                return device.gatt.connect().then(server => ({ server: server, deviceName: deviceName }));
            })
            .then(obj => {
                if (!obj) return;

                const server = obj.server;
                const deviceName = obj.deviceName;

                const serviceUUIDs = [
                    'd30a7847-e12b-09a8-b04b-8e0922a9abab',
                    'd10a7847-e12b-09a8-b04b-8e0922a9abab',
                    'a0345678-1234-5678-1234-56789abcdef1',
                    'a0345678-1234-5678-1234-56789abcdef0'
                ];

                const serviceMap = {
                    'd30a7847-e12b-09a8-b04b-8e0922a9abab': 'StepVariant1Closed',
                    'd10a7847-e12b-09a8-b04b-8e0922a9abab': 'StepVariant1Open',
                    'a0345678-1234-5678-1234-56789abcdef1': 'StepVariant2Closed',
                    'a0345678-1234-5678-1234-56789abcdef0': 'StepVariant2Open'
                };

                return Promise.all(serviceUUIDs.map(uuid => {
                    return server.getPrimaryService(uuid.toLowerCase())
                        .then(service => ({ uuid: uuid.toLowerCase(), service: service }))
                        .catch(() => null);
                }))
                .then(services => {
                    services = services.filter(serviceObj => serviceObj !== null);

                    if (services.length === 0) {
                        displayStatus('Unknown error');
                        return;
                    }

                    const matchedServiceObj = services[0];
                    const stepVariant = serviceMap[matchedServiceObj.uuid];

                    if (stepVariant.startsWith('StepVariant1')) {
                        handleStepVariant1(matchedServiceObj.service, deviceName);
                    } else if (stepVariant.startsWith('StepVariant2')) {
                        handleStepVariant2(matchedServiceObj.service, deviceName);
                    } else {
                        displayStatus('Unknown error');
                    }
                });
            })
            .catch(error => {
                console.log(error);
                displayStatus('Error: ' + error.message);
            });
        });

        function handleStepVariant1(service, deviceName) {
            const characteristicUUIDs = [
                '030b7847-e12b-09a8-b04b-8e0922a9abab',
                '040b7847-e12b-09a8-b04b-8e0922a9abab'
            ];

            Promise.all(characteristicUUIDs.map(uuid => {
                return service.getCharacteristic(uuid.toLowerCase())
                    .then(characteristic => characteristic.readValue())
                    .then(value => {
                        const decoder = new TextDecoder('utf-8');
                        const valString = decoder.decode(value).trim().toLowerCase();
                        const val = (valString === 'true' || valString === '1');
                        return { uuid: uuid.toLowerCase(), value: val };
                    })
                    .catch(error => {
                        console.log(error);
                        return null;
                    });
            }))
            .then(results => {
                results = results.filter(result => result !== null);

                let statusHtml = `<h2>${deviceName}</h2>`;
                results.forEach(result => {
                    if (result.uuid === '030b7847-e12b-09a8-b04b-8e0922a9abab') {
                        statusHtml += result.value
                            ? '<p class="green">Connected to router</p>'
                            : '<p class="red">Not connected to router</p>';
                    } else if (result.uuid === '040b7847-e12b-09a8-b04b-8e0922a9abab') {
                        statusHtml += result.value
                            ? '<p class="green">Connected to cloud</p>'
                            : '<p class="red">Not connected to cloud</p>';
                    }
                });
                displayStatus(statusHtml);
            })
            .catch(error => {
                console.log(error);
                displayStatus('Error: ' + error.message);
            });
        }

        function handleStepVariant2(service, deviceName) {
            const characteristicUUIDs = [
                'ababa922-098e-4bb0-a809-2be147780b03',
                'ababa922-098e-4bb0-a809-2be147780b04'
            ];

            Promise.all(characteristicUUIDs.map(uuid => {
                return service.getCharacteristic(uuid.toLowerCase())
                    .then(characteristic => characteristic.readValue())
                    .then(value => {
                        const decoder = new TextDecoder('utf-8');
                        const valString = decoder.decode(value).trim().toLowerCase();
                        const val = (valString === 'true' || valString === '1');
                        return { uuid: uuid.toLowerCase(), value: val };
                    })
                    .catch(error => {
                        console.log(error);
                        return null;
                    });
            }))
            .then(results => {
                results = results.filter(result => result !== null);

                let statusHtml = `<h2>${deviceName}</h2>`;
                results.forEach(result => {
                    if (result.uuid === 'ababa922-098e-4bb0-a809-2be147780b03') {
                        statusHtml += result.value
                            ? '<p class="green">Connected to router</p>'
                            : '<p class="red">Not connected to router</p>';
                    } else if (result.uuid === 'ababa922-098e-4bb0-a809-2be147780b04') {
                        statusHtml += result.value
                            ? '<p class="green">Connected to cloud</p>'
                            : '<p class="red">Not connected to cloud</p>';
                    }
                });
                displayStatus(statusHtml);
            })
            .catch(error => {
                console.log(error);
                displayStatus('Error: ' + error.message);
            });
        }

        function displayStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = message;
        }
    </script>
</body>
</html>
